# ------------------------------------------------------------
# {{ incoming_port }} TCP: {{ tcp_forwarding }} UDP: {{ udp_forwarding }}
# DO NOT EDIT THIS FILE DIRECTLY, CHANGES WILL BE LOST WHEN UPDATING!
# ------------------------------------------------------------

{% if enabled %}
  {% if tcp_forwarding %}
    server {
      listen {{ env.IPV4_BINDING }}:{{ incoming_port }}{% if certificate and certificate_id > 0 %} ssl{% endif %};
      {% if env.DISABLE_IPV6 == "false" %}listen {{ env.IPV6_BINDING }}:{{ incoming_port }}{% if certificate and certificate_id > 0 %} ssl{% endif %};{% endif %}

      {% if certificate and certificate_id > 0 %}
        {% if certificate.provider == "letsencrypt" %}
          # Certbot TLS
          ssl_certificate /data/tls/certbot/live/npm-{{ certificate_id }}/fullchain.pem;
          ssl_certificate_key /data/tls/certbot/live/npm-{{ certificate_id }}/privkey.pem;
          {% if env.ACME_OCSP_STAPLING == "true" %}
            ssl_stapling on;
            ssl_stapling_verify on;
            ssl_stapling_file /data/tls/certbot/live/npm-{{ certificate_id }}.der;
          {% endif %}
        {% else %}
          # Custom TLS
          ssl_certificate /data/tls/custom/npm-{{ certificate_id }}/fullchain.pem;
          ssl_certificate_key /data/tls/custom/npm-{{ certificate_id }}/privkey.pem;
          {% if env.CUSTOM_OCSP_STAPLING == "true" %}
            ssl_stapling on;
            ssl_stapling_verify on;
            ssl_stapling_file /data/tls/custom/npm-{{ certificate_id }}.der;
          {% endif %}
        {% endif %}
      {% endif %}

      proxy_pass {{ forwarding_host }}:{{ forwarding_port }};

      # Custom
      include /data/custom_nginx/server_stream.conf;
      include /data/custom_nginx/server_stream_tcp.conf;
    }
  {% endif %}
  {% if udp_forwarding %}
    server {
      listen {{ env.IPV4_BINDING }}:{{ incoming_port }} udp reuseport;
      {% if env.DISABLE_IPV6 == "false" %}listen {{ env.IPV6_BINDING }}:{{ incoming_port }} udp reuseport;{% endif %}

      {% if certificate and certificate_id > 0 %}
        {% if certificate.provider == "letsencrypt" %}
          # Certbot TLS
          ssl_certificate /data/tls/certbot/live/npm-{{ certificate_id }}/fullchain.pem;
          ssl_certificate_key /data/tls/certbot/live/npm-{{ certificate_id }}/privkey.pem;
          {% if env.ACME_OCSP_STAPLING == "true" %}
            ssl_stapling on;
            ssl_stapling_verify on;
            ssl_stapling_file /data/tls/certbot/live/npm-{{ certificate_id }}.der;
          {% endif %}
        {% else %}
          # Custom TLS
          ssl_certificate /data/tls/custom/npm-{{ certificate_id }}/fullchain.pem;
          ssl_certificate_key /data/tls/custom/npm-{{ certificate_id }}/privkey.pem;
          {% if env.CUSTOM_OCSP_STAPLING == "true" %}
            ssl_stapling on;
            ssl_stapling_verify on;
            ssl_stapling_file /data/tls/custom/npm-{{ certificate_id }}.der;
          {% endif %}
        {% endif %}
      {% endif %}

      proxy_pass {{ forwarding_host }}:{{ forwarding_port }};

      # Custom
      include /data/custom_nginx/server_stream.conf;
      include /data/custom_nginx/server_stream_udp.conf;
    }
  {% endif %}
{% endif %}
