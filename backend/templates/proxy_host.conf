{% include "_header_comment.conf" %}
{% assign forward_host_first_char = forward_host | slice: 0 -%}
{% assign forward_host_last_char = forward_host | slice: -1 -%}

{% if enabled %}
  server {
    set $forward_scheme "{{ forward_scheme }}";
    set $server         "{{ forward_host }}";
    set $port           "{{ forward_port }}";
    set $forward_path   "{{ forward_path }}";

    {% include "_common.conf" %}

    {% if access_list_id > 0 %}
      {% if access_list.items.length > 0 %}
        # Authorization
        auth_basic            "Authorization required";
        auth_basic_user_file  /data/access/{{ access_list_id }};
        {% if access_list.pass_auth %}
          proxy_set_header Authorization "";
        {% endif %}
      {% endif %}
      # Access Rules: {{ access_list.clients | size }} total
      {% for client in access_list.clients %}
        {{client | nginxAccessRule}}
      {% endfor %}
      deny all;
      # Access checks must...
      {% if access_list.satisfy_any %}
        satisfy any;
      {% else %}
        satisfy all;
      {% endif %}
    {% endif %}

    {% if block_exploits %}
      modsecurity on;
      {% if caching_enabled %}
        modsecurity_rules_file /usr/local/nginx/conf/conf.d/include/modsecurity-crs.conf;
      {% else %}
        modsecurity_rules_file /usr/local/nginx/conf/conf.d/include/modsecurity.conf;
      {% endif %}
    {% endif %}

    {% if use_default_location %}
      location / {
        {% if forward_host_first_char == "/" and forward_host_last_char == "/" %}
          alias {{ forward_host }};
          {% if forward_port != null %}
            location ~* \.php(?:$|/) {
              fastcgi_split_path_info ^(.*\.php)(/.*)$;
              try_files $fastcgi_script_name =404;
              fastcgi_pass unix:/run/php{{ forward_port }}.sock;
            }
          {% endif %}
        {% elsif forward_host_first_char == "/" and forward_host_last_char != "/" %}
          root {{ forward_host }};
          {% if forward_port != null %}
            location ~* \.php(?:$|/) {
              fastcgi_split_path_info ^(.*\.php)(/.*)$;
              try_files $fastcgi_script_name =404;
              fastcgi_pass unix:/run/php{{ forward_port }}.sock;
            }
          {% endif %}
        {% else %}
          {% if forward_scheme == "grpc" or forward_scheme == "grpcs" %}
            include conf.d/include/grpc-headers.conf;
            grpc_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};
          {% else %}
            include conf.d/include/proxy-headers.conf;
            proxy_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};
          {% endif %}
        {% endif %}
      }
    {% endif %}

    # custom locations
    {{ locations }}

    # Custom
    include /data/custom_nginx/server_proxy.conf;
  }
{% endif %}
