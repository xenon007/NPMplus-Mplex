{% assign path_first_char = path | slice: 0 -%}
{% assign path_last_char = path | slice: -1 -%}

{% if path != "/" and path_first_char == "/" and path_last_char == "/" %}
  location {{ path | remove_last: "/" }} {
    absolute_redirect off;
    return 301 {{ path }};
  }
{% endif %}

location {{ path }} {
  set $forward_scheme "{{ forward_scheme }}";
  set $server         "{{ forward_host }}";
  set $port           "{{ forward_port }}";
  set $forward_path   "{{ forward_path }}";

  {{ advanced_config }}
    
  {% if forward_host_first_char == "/" and forward_host_last_char == "/" %}
    alias {{ forward_host }};
    {% if forward_port != null %}
      location ~* \.php(?:$|/) {
        fastcgi_split_path_info ^(.*\.php)(/.*)$;
        try_files $fastcgi_script_name =404;
        fastcgi_pass unix:/run/php{{ forward_port }}.sock;
      }
    {% endif %}
  {% elsif forward_host_first_char == "/" and forward_host_last_char != "/" %}
    root {{ forward_host }};
    {% if forward_port != null %}
      location ~* \.php(?:$|/) {
        fastcgi_split_path_info ^(.*\.php)(/.*)$;
        try_files $fastcgi_script_name =404;
        fastcgi_pass unix:/run/php{{ forward_port }}.sock;
      }
    {% endif %}
  {% else %}
    {% if forward_scheme == "grpc" or forward_scheme == "grpcs" %}
      include conf.d/include/grpc-headers.conf;
      grpc_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};
    {% else %}
      include conf.d/include/proxy-headers.conf;
      proxy_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{% if forward_path != null %}{{ forward_path }}{% else %}$request_uri{% endif %};
    {% endif %}
  {% endif %}
}
